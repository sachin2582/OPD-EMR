<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Billing Doctor Selection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .feature-list {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .feature-list h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .feature-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .feature-list li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üßæ Test Billing Doctor Selection Feature</h1>
    
    <div class="feature-list">
        <h3>‚úÖ New Features Implemented:</h3>
        <ul>
            <li><strong>Doctor Selection Field:</strong> Added doctor dropdown in billing form</li>
            <li><strong>Mandatory for Consultation:</strong> Doctor selection required only for consultation services</li>
            <li><strong>Validation:</strong> Prevents adding consultation services without doctor selection</li>
            <li><strong>Visual Feedback:</strong> Shows selected doctor in service list and invoice</li>
            <li><strong>Print Integration:</strong> Doctor name appears in printed invoice</li>
            <li><strong>Database Integration:</strong> Fetches doctors from API and saves doctor info with bill</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç Test Doctor API</h2>
        <p>Test if the doctors API is working and returning doctor data.</p>
        <button class="test-button" onclick="testDoctorsAPI()">Test Doctors API</button>
        <div id="doctorsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üß™ Test Consultation Service Logic</h2>
        <p>Test the consultation service validation logic.</p>
        <button class="test-button" onclick="testConsultationLogic()">Test Consultation Logic</button>
        <div id="consultationResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìã Test Bill Creation with Doctor</h2>
        <p>Test creating a bill with consultation services and doctor selection.</p>
        <button class="test-button" onclick="testBillWithDoctor()">Test Bill Creation</button>
        <div id="billResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Manual Testing Instructions</h2>
        <div class="info">
            <h3>Steps to Test in the Application:</h3>
            <ol>
                <li><strong>Open Billing Page:</strong> Navigate to the billing screen in the application</li>
                <li><strong>Load Patient:</strong> Enter a patient registration number and load patient data</li>
                <li><strong>Check Doctor Selection:</strong> Verify the "Doctor Selection" section appears</li>
                <li><strong>Select Doctor:</strong> Choose a doctor from the dropdown</li>
                <li><strong>Add Consultation Service:</strong> Try adding "Consultation Fee" or "Specialist Consultation"</li>
                <li><strong>Verify Validation:</strong> Try adding consultation service without selecting doctor (should show warning)</li>
                <li><strong>Add with Doctor:</strong> Add consultation service after selecting doctor (should work)</li>
                <li><strong>Check Service Display:</strong> Verify doctor name appears in selected services</li>
                <li><strong>Test Other Services:</strong> Add non-consultation services (should work without doctor)</li>
                <li><strong>Print/Save:</strong> Test printing and saving bills with doctor information</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>üîß Expected Behavior</h2>
        <div class="info">
            <h3>Doctor Selection Requirements:</h3>
            <ul>
                <li><strong>Consultation Fee:</strong> Requires doctor selection ‚úÖ</li>
                <li><strong>Specialist Consultation:</strong> Requires doctor selection ‚úÖ</li>
                <li><strong>X-Ray, ECG, Ultrasound:</strong> No doctor required ‚úÖ</li>
                <li><strong>Lab Tests:</strong> No doctor required ‚úÖ</li>
                <li><strong>Dressing, Injection:</strong> No doctor required ‚úÖ</li>
            </ul>
            
            <h3>Validation Messages:</h3>
            <ul>
                <li>Warning when trying to add consultation without doctor</li>
                <li>Success message when adding consultation with doctor</li>
                <li>Error when trying to print/save without doctor for consultation</li>
            </ul>
        </div>
    </div>

    <script>
        async function testDoctorsAPI() {
            const resultDiv = document.getElementById('doctorsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing doctors API...</p>';
            
            try {
                const response = await fetch('http://localhost:3001/api/doctors');
                const data = await response.json();
                
                if (data.success && data.doctors) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Doctors API Working!</h3>
                        <p><strong>Total Doctors:</strong> ${data.doctors.length}</p>
                        <p><strong>Sample Doctors:</strong></p>
                        <ul>
                            ${data.doctors.slice(0, 3).map(doctor => 
                                `<li>Dr. ${doctor.name} - ${doctor.specialization}</li>`
                            ).join('')}
                        </ul>
                        <p><em>‚úÖ Doctor data is available for billing selection</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Doctors API Error</h3>
                        <p><strong>Response:</strong> ${JSON.stringify(data)}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Make sure the backend server is running on http://localhost:3001</p>
                `;
            }
        }
        
        function testConsultationLogic() {
            const resultDiv = document.getElementById('consultationResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            
            // Simulate consultation service validation
            const consultationServices = [
                { id: 1, name: 'Consultation Fee', category: 'Consultation', price: 500 },
                { id: 2, name: 'Specialist Consultation', category: 'Consultation', price: 1000 }
            ];
            
            const nonConsultationServices = [
                { id: 5, name: 'X-Ray', category: 'Radiology', price: 1200 },
                { id: 6, name: 'ECG', category: 'Cardiology', price: 600 }
            ];
            
            resultDiv.innerHTML = `
                <h3>‚úÖ Consultation Logic Test</h3>
                <p><strong>Consultation Services (require doctor):</strong></p>
                <ul>
                    ${consultationServices.map(service => 
                        `<li>${service.name} - Category: ${service.category} ‚úÖ</li>`
                    ).join('')}
                </ul>
                <p><strong>Non-Consultation Services (no doctor required):</strong></p>
                <ul>
                    ${nonConsultationServices.map(service => 
                        `<li>${service.name} - Category: ${service.category} ‚úÖ</li>`
                    ).join('')}
                </ul>
                <p><em>‚úÖ Logic correctly identifies consultation vs non-consultation services</em></p>
            `;
        }
        
        async function testBillWithDoctor() {
            const resultDiv = document.getElementById('billResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing bill creation with doctor...</p>';
            
            try {
                // Test bill creation with consultation service and doctor
                const billData = {
                    billNumber: 'TEST-BILL-' + Date.now(),
                    billDate: new Date().toISOString().split('T')[0],
                    patientId: '1',
                    selectedServices: [
                        {
                            id: 1,
                            name: 'Consultation Fee',
                            category: 'Consultation',
                            price: 500,
                            quantity: 1,
                            total: 500,
                            selectedDoctor: 'Dr. Suneet Verma'
                        }
                    ],
                    subtotal: 500,
                    discount: 0,
                    discountAmount: 0,
                    total: 500,
                    paymentMethod: 'cash',
                    notes: 'Test bill with doctor selection',
                    selectedDoctor: 'Dr. Suneet Verma'
                };
                
                const response = await fetch('http://localhost:3001/api/bills', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(billData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Bill Created Successfully!</h3>
                        <p><strong>Bill Number:</strong> ${billData.billNumber}</p>
                        <p><strong>Total Amount:</strong> ‚Çπ${billData.total}</p>
                        <p><strong>Selected Doctor:</strong> ${billData.selectedDoctor}</p>
                        <p><strong>Services:</strong></p>
                        <ul>
                            ${billData.selectedServices.map(service => 
                                `<li>${service.name} - Dr. ${service.selectedDoctor}</li>`
                            ).join('')}
                        </ul>
                        <p><em>‚úÖ Bill saved with doctor information successfully</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Bill Creation Failed</h3>
                        <p><strong>Error:</strong> ${data.error || data.message}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Make sure the backend server is running</p>
                `;
            }
        }
    </script>
</body>
</html>
