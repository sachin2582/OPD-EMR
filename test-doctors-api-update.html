<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Doctors API Update</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .feature-list {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .feature-list h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .feature-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .feature-list li {
            margin: 5px 0;
        }
        .doctor-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        .doctor-card h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .doctor-card p {
            margin: 2px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üë®‚Äç‚öïÔ∏è Test Doctors API Update (User Type Filtering)</h1>
    
    <div class="feature-list">
        <h3>‚úÖ Changes Implemented:</h3>
        <ul>
            <li><strong>Doctors API Updated:</strong> Now fetches from users table with type = 'D'</li>
            <li><strong>User Type Filtering:</strong> Only users with type 'D' are returned as doctors</li>
            <li><strong>Doctor Creation:</strong> Automatically sets user type to 'D' when creating doctors</li>
            <li><strong>All Components Updated:</strong> Billing, AppointmentScheduler, UserManagement, AdminPanel</li>
            <li><strong>Consistent API Response:</strong> All components now use response.data.doctors format</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç Test Updated Doctors API</h2>
        <p>Test the new doctors API that fetches from users table with type = 'D'.</p>
        <button class="test-button" onclick="testDoctorsAPI()">Test Doctors API</button>
        <div id="doctorsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üë• Test User Type Filtering</h2>
        <p>Verify that only users with type = 'D' are returned as doctors.</p>
        <button class="test-button" onclick="testUserTypeFiltering()">Test User Type Filtering</button>
        <div id="userTypeResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üß™ Test Doctor Creation</h2>
        <p>Test creating a new doctor and verify user type is set to 'D'.</p>
        <button class="test-button" onclick="testDoctorCreation()">Test Doctor Creation</button>
        <div id="creationResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìã Test All Components</h2>
        <p>Test that all components can fetch doctors correctly.</p>
        <button class="test-button" onclick="testAllComponents()">Test All Components</button>
        <div id="componentsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Manual Testing Instructions</h2>
        <div class="info">
            <h3>Steps to Test in the Application:</h3>
            <ol>
                <li><strong>Billing Page:</strong> Check doctor dropdown shows only type 'D' users</li>
                <li><strong>Appointment Scheduler:</strong> Verify doctor selection works</li>
                <li><strong>User Management:</strong> Check doctor assignment dropdown</li>
                <li><strong>Admin Panel:</strong> Verify doctor statistics and management</li>
                <li><strong>Doctor Management:</strong> Create new doctor and verify user type 'D'</li>
            </ol>
        </div>
    </div>

    <script>
        async function testDoctorsAPI() {
            const resultDiv = document.getElementById('doctorsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing updated doctors API...</p>';
            
            try {
                const response = await fetch('http://localhost:3001/api/doctors');
                const data = await response.json();
                
                if (data.success && data.doctors) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Doctors API Working!</h3>
                        <p><strong>Total Doctors:</strong> ${data.doctors.length}</p>
                        <p><strong>Response Format:</strong> response.data.doctors ‚úÖ</p>
                        <p><strong>Sample Doctors:</strong></p>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${data.doctors.slice(0, 5).map(doctor => `
                                <div class="doctor-card">
                                    <h4>Dr. ${doctor.name}</h4>
                                    <p><strong>Username:</strong> ${doctor.username}</p>
                                    <p><strong>Specialization:</strong> ${doctor.specialization || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${doctor.email || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${doctor.phone || 'N/A'}</p>
                                </div>
                            `).join('')}
                        </div>
                        <p><em>‚úÖ All doctors are users with type = 'D'</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Doctors API Error</h3>
                        <p><strong>Response:</strong> ${JSON.stringify(data)}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Make sure the backend server is running on http://localhost:3001</p>
                `;
            }
        }
        
        async function testUserTypeFiltering() {
            const resultDiv = document.getElementById('userTypeResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing user type filtering...</p>';
            
            try {
                // Test both users API and doctors API
                const [usersResponse, doctorsResponse] = await Promise.all([
                    fetch('http://localhost:3001/api/users'),
                    fetch('http://localhost:3001/api/doctors')
                ]);
                
                const usersData = await usersResponse.json();
                const doctorsData = await doctorsResponse.json();
                
                if (usersData.success && doctorsData.success) {
                    const allUsers = usersData.users || [];
                    const doctorUsers = allUsers.filter(user => user.type === 'D');
                    const apiDoctors = doctorsData.doctors || [];
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ User Type Filtering Working!</h3>
                        <p><strong>Total Users:</strong> ${allUsers.length}</p>
                        <p><strong>Users with type 'D':</strong> ${doctorUsers.length}</p>
                        <p><strong>Doctors API Returns:</strong> ${apiDoctors.length}</p>
                        <p><strong>Filtering Status:</strong> ${doctorUsers.length === apiDoctors.length ? '‚úÖ Perfect Match' : '‚ö†Ô∏è Mismatch'}</p>
                        <p><strong>Sample Type 'D' Users:</strong></p>
                        <ul>
                            ${doctorUsers.slice(0, 3).map(user => 
                                `<li>${user.username} - ${user.fullName} (Type: ${user.type})</li>`
                            ).join('')}
                        </ul>
                        <p><em>‚úÖ Only users with type 'D' are returned as doctors</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå API Error</h3>
                        <p><strong>Users API:</strong> ${usersData.success ? 'OK' : 'Failed'}</p>
                        <p><strong>Doctors API:</strong> ${doctorsData.success ? 'OK' : 'Failed'}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }
        
        async function testDoctorCreation() {
            const resultDiv = document.getElementById('creationResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing doctor creation...</p>';
            
            try {
                const testDoctor = {
                    name: 'Test Doctor ' + Date.now(),
                    specialization: 'General Medicine',
                    contactNumber: '9876543210',
                    email: 'testdoctor' + Date.now() + '@example.com',
                    qualification: 'MBBS',
                    experienceYears: 5,
                    availability: 'Mon-Fri 9AM-5PM',
                    username: 'testdoctor' + Date.now(),
                    password: 'testpass123'
                };
                
                const response = await fetch('http://localhost:3001/api/doctors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testDoctor)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Verify the created user has type 'D'
                    const usersResponse = await fetch('http://localhost:3001/api/users');
                    const usersData = await usersResponse.json();
                    
                    const createdUser = usersData.users.find(user => user.username === testDoctor.username);
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Doctor Created Successfully!</h3>
                        <p><strong>Doctor Name:</strong> ${testDoctor.name}</p>
                        <p><strong>Username:</strong> ${testDoctor.username}</p>
                        <p><strong>User Type:</strong> ${createdUser ? createdUser.type : 'Not found'}</p>
                        <p><strong>Type Check:</strong> ${createdUser && createdUser.type === 'D' ? '‚úÖ Correct' : '‚ùå Incorrect'}</p>
                        <p><strong>Doctor ID:</strong> ${data.doctor.doctorId}</p>
                        <p><em>‚úÖ New doctor user automatically has type = 'D'</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Doctor Creation Failed</h3>
                        <p><strong>Error:</strong> ${data.error || data.message}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }
        
        async function testAllComponents() {
            const resultDiv = document.getElementById('componentsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>üîÑ Testing all components...</p>';
            
            try {
                // Test the main doctors API endpoint
                const response = await fetch('http://localhost:3001/api/doctors');
                const data = await response.json();
                
                if (data.success && data.doctors) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ All Components Should Work!</h3>
                        <p><strong>API Endpoint:</strong> /api/doctors ‚úÖ</p>
                        <p><strong>Response Format:</strong> { success: true, doctors: [...] } ‚úÖ</p>
                        <p><strong>Total Doctors Available:</strong> ${data.doctors.length}</p>
                        <p><strong>Components Updated:</strong></p>
                        <ul>
                            <li>‚úÖ Billing.js - Doctor selection for consultation</li>
                            <li>‚úÖ AppointmentScheduler.js - Doctor dropdown</li>
                            <li>‚úÖ UserManagement.js - Doctor assignment</li>
                            <li>‚úÖ AdminPanel.js - Doctor statistics</li>
                            <li>‚úÖ DoctorsManagement.js - Doctor management</li>
                        </ul>
                        <p><em>‚úÖ All components now use consistent API format</em></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå API Not Working</h3>
                        <p><strong>Response:</strong> ${JSON.stringify(data)}</p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Network Error</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>
